pipeline {
    agent any
    
    tools {
        maven 'maven'
        jdk 'jdk-17'
    }
    
    environment {
        SCANNER_HOME = tool 'sonar'
        IMAGE_NAME = 'dinesh4136/java-webapp'
        IMAGE_TAG = "build-${BUILD_NUMBER}"
    }
    
    stages {
        stage('Code Checkout') {
            steps {
                checkout scmGit(branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/dinesh-4136/JavaWebCalculator.git']])
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }
        
        stage('SonarCloud Analysis') {
            steps {
                withSonarQubeEnv('sonar') {
                    withCredentials([string(credentialsId: 'SONAR_TOKEN', variable: 'SONAR_TOKEN')]) {
                        sh """
                            \$SCANNER_HOME/bin/sonar-scanner \
                            -Dsonar.projectKey=dinesh-4136_JavaWebCalculator \
                            -Dsonar.organization=dinesh-4136 \
                            -Dsonar.sources=. \
                            -Dsonar.java.binaries=target/classes \
                            -Dsonar.host.url=https://sonarcloud.io \
                            -Dsonar.login=\$SONAR_TOKEN
                        """
                    }
                }
            }
        }

        /* stage('Quality Gate') {
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        } */

        stage('Build Docker Image') {
            steps {
                echo "Building Docker image with tag: ${IMAGE_TAG}"
                sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
            }
        }
        
        stage('Push Image to DockerHub') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'DOCKERHUB_LOGIN', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh """
                        docker login -u $DOCKER_USER -p $DOCKER_PASS
                        docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }
        
        stage('Deploy to EKS') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'AWS_CREDENTIALS']]) {
                    sh '''
                        AWS_REGION="us-east-1"
                        CLUSTER_NAME="my-cluster"
                        
                        echo "üîß Setting up KUBECONFIG for EKS cluster: $CLUSTER_NAME ..."
                        aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME

                        echo "üìù Updating and Deploying image: $FULL_IMAGE_NAME to EKS..."
                        sed "s|<your-image-name>|${IMAGE_NAME}|g; \
                             s|<your-image-tag>|${IMAGE_TAG}|g" \
                             k8s/deployment.yaml | kubectl apply -f -

                        echo "üì¶ Applying service manifest..."
                        kubectl apply -f k8s/service.yaml
                        
                        echo "üì¶ Applying ingress manifest..."
                        kubectl apply -f k8s/ingress.yaml

                     '''
                }
            }
        }
        
        stage('Deploy Monitoring Stack (Prometheus + Grafana)') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'AWS_CREDENTIALS']]) {
                    sh '''
                        echo "üöÄ Adding Helm repositories for Prometheus and Grafana..."
                        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
                        helm repo add grafana https://grafana.github.io/helm-charts || true
                        helm repo update
                        
                        echo "üß≠ Creating monitoring namespace..."
                        kubectl create namespace monitoring || true
                        
                        echo "üìä Installing Prometheus..."
                        helm upgrade --install prometheus prometheus-community/prometheus -n monitoring

                        echo "üìà Installing Grafana..."
                        helm upgrade --install grafana grafana/grafana -n monitoring
                        
                        echo "‚úÖ Waiting for all monitoring pods to be ready..."
                        kubectl wait --for=condition=Ready pods --all -n monitoring --timeout=480s || true
                        
                        echo "üîç Getting Grafana admin credentials..."
                        GRAFANA_PASS=$(kubectl get secret --namespace monitoring grafana -o jsonpath="{.data.admin-password}" | base64 --decode)
                        echo "Grafana admin password: $GRAFANA_PASS"

                        echo "üéØ Monitoring stack deployed successfully!"
                        kubectl get svc -n monitoring
                    '''
                }
            }
        }
    }
}
